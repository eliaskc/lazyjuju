#!/usr/bin/env node

const childProcess = require("child_process")
const fs = require("fs")
const path = require("path")
const os = require("os")

function run(target) {
  const result = childProcess.spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  process.exit(typeof result.status === "number" ? result.status : 0)
}

const envPath = process.env.KAJJI_BIN_PATH
if (envPath) {
  run(envPath)
}

const scriptPath = fs.realpathSync(__filename)
const scriptDir = path.dirname(scriptPath)

const platformMap = { darwin: "darwin", linux: "linux" }
const archMap = { x64: "x64", arm64: "arm64" }

const platform = platformMap[os.platform()] || os.platform()
const arch = archMap[os.arch()] || os.arch()
const base = "kajji-" + platform + "-" + arch

function findBinary(startDir) {
  let current = startDir
  for (;;) {
    const modules = path.join(current, "node_modules")
    if (fs.existsSync(modules)) {
      for (const entry of fs.readdirSync(modules)) {
        if (!entry.startsWith(base)) continue
        const candidate = path.join(modules, entry, "bin", "kajji")
        if (fs.existsSync(candidate)) return candidate
      }
    }
    const parent = path.dirname(current)
    if (parent === current) return
    current = parent
  }
}

const resolved = findBinary(scriptDir)
if (!resolved) {
  console.error(
    `Could not find kajji binary for your platform (${platform}-${arch}).\n` +
    `Try installing the platform package: npm install ${base}`
  )
  process.exit(1)
}

run(resolved)
